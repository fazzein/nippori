<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nippori Sistem</title>
    <link rel="icon" href="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wgARCAAoACgDAREAAhEBAxEB/8QAHAABAAICAwEAAAAAAAAAAAAAAAYHBAUBAgMI/8QAGQEBAQEBAQEAAAAAAAAAAAAAAAECAwQG/9oADAMBAAIQAxAAAAD3wAAAAA4c2s3G9Z58S2lT1vEa4SklLqV7dE4+lQAAAAAP/EACQQAQACAQIGAgMAAAAAAAAAAAUDBAYBAgcIERITFCEiMTJR/9oACAEBAAEFAv68FvHkPqL5e22T2K+Poe36S9s6Pj+hL3fR2z+m/pG7RkPqL+Y7rG/c55e67R2K+Xuv0v6S9u6Pj+h/3fR2wum/pG794//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AR//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAsEAABAgIABAQGAwAAAAAAAAABAgMEAAUREhMhFCAxUVIQIiMyQUNQYXHB/9oACAEBAAY/Av2K7V94w3g4xU4gY6g/QxhvAxeoP0cYbwMvUF+jjDeBle/X6OMN4GV78v0cYaX2q7V9oQ3gYzUF+jjDeBjNQv0cYaXv8v0cYaXvy/RxhpfbL9HGGl9qufeEN4GJ1Bfo4w3gYnUv6OMNL7JfY4w0vtl9jjDS92X6OMNL3Zfo4w0vtl9jjDS+1Xav/2Q==" type="image/jpeg">
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --nippori-blue: #1E2A4D;
            --nippori-red: #D9303B;
            --nippori-gold: #F1B532;
            --light-gray: #f8f9fa;
            --dark-gray: #495057;
            --border-color: #dee2e6;
            --success: #28a745;
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--light-gray);
            color: var(--dark-gray);
            margin: 0;
            display: flex;
        }
        .main-nav {
            width: 240px;
            background-color: #ffffff;
            height: 100vh;
            position: sticky;
            top: 0;
            border-right: 1px solid var(--border-color);
            padding: 20px;
            box-sizing: border-box;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }
        .nav-header {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--nippori-blue);
            text-align: center;
            margin-bottom: 30px;
        }
        .nav-links { list-style: none; padding: 0; margin: 0; }
        .nav-links a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            text-decoration: none;
            color: var(--dark-gray);
            font-weight: 600;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: background-color 0.2s, color 0.2s;
        }
        .nav-links a:hover, .nav-links a.active {
            background-color: var(--nippori-blue);
            color: white;
        }
        .main-content {
            flex-grow: 1;
            padding: 30px;
            max-width: calc(100% - 280px);
        }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .card {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }
        h1, h2 {
            color: var(--nippori-blue);
            border-bottom: 2px solid var(--nippori-gold);
            padding-bottom: 10px;
            margin-top: 0;
        }
        h2.batch-header {
            border-bottom: 1px solid var(--border-color);
            font-size: 1.2em;
            margin-top: 25px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label { display: block; margin-bottom: 8px; font-weight: 600; }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            box-sizing: border-box;
            font-family: inherit;
            font-size: 1em;
        }
        button {
            padding: 14px;
            background-color: var(--nippori-gold);
            color: var(--nippori-blue);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(241, 181, 50, 0.3);
        }
        .product-list-card {
            display: flex;
            flex-direction: column;
            max-height: 85vh;
        }
        #product-list-container {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 15px;
        }
        .product-list-header {
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .product-list-footer {
            flex-shrink: 0;
            padding-top: 15px;
            position: sticky;
            bottom: -30px;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            margin: 0 -30px -30px -30px;
            padding: 15px 30px;
            border-top: 1px solid var(--border-color);
        }
        .product-group-card {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        .group-header {
            display: flex;
            align-items: center;
            padding: 15px;
            background-color: #f8f9fa;
            cursor: pointer;
        }
        .group-header .action-btn {
            margin-left: 15px;
        }
        .group-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 15px;
        }
        .group-title { flex-grow: 1; font-size: 1.2em; font-weight: 700; color: var(--nippori-blue); }
        .variant-list { list-style: none; padding: 0; margin: 0; display: none; }
        .product-group-card.expanded .variant-list { display: block; }
        .group-toggle-icon { margin-left: 10px; transition: transform 0.3s; }
        .product-group-card.expanded .group-toggle-icon { transform: rotate(90deg); }

        .variant-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-top: 1px solid #f1f3f5;
        }
        .variant-item.low-stock {
            background-color: rgba(217, 48, 59, 0.05);
            border-left: 4px solid var(--nippori-red);
        }
        .variant-image {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 6px;
            margin-right: 12px;
            cursor: pointer;
        }
        .variant-details { flex-grow: 1; }
        .variant-details p { margin: 0 0 4px 0; font-size: 14px; }
        .variant-actions { display: flex; gap: 8px; margin-left: auto; align-items: center; }
        .action-btn { font-size: 12px; padding: 6px 10px; width: auto; }
        .edit-btn { background-color: var(--nippori-blue); color: white; }
        .delete-btn { background-color: var(--nippori-red); color: white; }
        .history-btn { background-color: #6c757d; color: white; }
        .quick-add-btn { background-color: var(--success); color: white; padding: 5px 8px; font-size: 1.2em; border-radius: 50%; width: 32px; height: 32px; line-height: 1; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-content img { max-width: 90vw; max-height: 90vh; }
        .modal-close {
            position: absolute; top: 15px; right: 15px;
            width: 30px; height: 30px; border-radius: 50%; background: var(--nippori-red); color: white;
            border: none; font-size: 18px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; line-height: 1; padding: 0;
        }
        .modal-inner-content { background-color: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 800px; position: relative; }
        .variant-input-group {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .filter-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .footer-actions-wrapper { display: flex; justify-content: space-between; gap: 20px; flex-wrap: wrap; }
        .actions-container { display: flex; gap: 15px; }
        .select-all-container { grid-column: 1 / -1; display: flex; align-items: center; background-color: #f0f0f0; padding: 10px; border-radius: 8px;}
        .select-all-container label { margin: 0; flex-grow: 1; }
        .product-counts { text-align: right; margin-bottom: 10px; font-size: 0.9em; }
        .fitur-container { display: flex; flex-direction: column; gap: 10px; }
        .fitur-item { display: flex; align-items: center; }
        .fitur-item input { width: auto; margin-right: 10px; }
        .fitur-item label { margin: 0; font-weight: normal; }
        .price-group { display: flex; gap: 15px; }
        .price-group .form-group { flex: 1; }
        .price-display { display: flex; align-items: center; gap: 8px; font-size: 14px; margin-top: 4px; }
        .price-normal { text-decoration: line-through; color: #9e9e9e; }
        .price-diskon { font-weight: bold; color: var(--nippori-red); }
        .diskon-badge { background-color: var(--nippori-red); color: white; font-size: 10px; padding: 2px 5px; border-radius: 4px; font-weight: bold; }
        .discount-preview { text-align: right; font-weight: bold; color: var(--nippori-red); height: 1em; margin-top: -15px; margin-bottom: 10px; }
        .bulk-edit-container {
            background-color: #f1f3f5;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .batch-generator { display: flex; gap: 10px; align-items: center; }
        .batch-generator input { flex: 1; }
        .batch-generator button { width: auto; flex-shrink: 0; padding: 12px 15px;}
        
        /* Dashboard styles */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 12px; text-align: center; }
        .stat-card.clickable { cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .stat-card.clickable:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
        .stat-card h3 { margin-top: 0; color: var(--nippori-blue); }
        .stat-card .stat-number { font-size: 2.5em; font-weight: 700; color: var(--nippori-gold); }
        .stat-card .stat-label { font-size: 0.9em; color: var(--dark-gray); margin-top: -10px; }
        .low-stock-list, .sold-items-list, .master-report-list, #download-links-list { list-style: none; padding: 0; text-align: left; }
        .low-stock-list li, .sold-items-list li, .master-report-list li, #download-links-list li { padding: 8px; border-bottom: 1px solid var(--border-color); }
        .low-stock-list li { 
            cursor: default; 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            gap: 10px;
        }
        .low-stock-list li:hover { background-color: #f1f3f5; }
        .low-stock-image { width: 40px; height: 40px; object-fit: cover; border-radius: 6px; }
        .low-stock-details { display: flex; align-items: center; gap: 10px; flex-grow: 1; }
        .low-stock-actions { display: flex; gap: 8px;}
        
        /* Modal lists */
        #history-modal-list, #sold-items-modal-list, #master-report-modal-list, #download-links-list { max-height: 400px; overflow-y: auto; }
        #history-modal-list li, #sold-items-modal-list li, .master-report-list li, #download-links-list li { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        #history-modal-list .change-plus, #sold-items-modal-list .change-plus { color: var(--success); }
        #history-modal-list .change-minus, #sold-items-modal-list .change-minus { color: var(--nippori-red); }
        #sold-items-totals { text-align: center; margin-bottom: 20px; padding: 10px; background-color: #f0f0f0; border-radius: 8px; }
        #pdf-options-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;}
        .batch-subheader {
            font-size: 1em;
            font-weight: bold;
            color: var(--dark-gray);
            margin-top: 15px;
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }
        .batch-subheader:first-child {
            margin-top: 0;
        }
        
        /* Pagination */
        #pagination-container, #low-stock-pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }
        .page-btn {
            background-color: #fff;
            color: var(--nippori-blue);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            margin: 0 4px;
            cursor: pointer;
            width: auto;
        }
        .page-btn:hover, .page-btn.active {
            background-color: var(--nippori-blue);
            color: white;
        }

        /* Notification styles */
        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }
        .notification {
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transform: translateX(calc(100% + 20px));
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        .notification.success { background-color: var(--success); }
        .notification.error { background-color: var(--nippori-red); }
        .notification.info { background-color: var(--nippori-blue); }
    </style>
</head>
<body>
    <nav class="main-nav">
        <div class="nav-header">Nippori Sistem</div>
        <ul class="nav-links">
            <li><a href="#dashboard" class="nav-link active">Dashboard</a></li>
            <li><a href="#produk" class="nav-link">Produk</a></li>
            <li><a href="#data-list" class="nav-link">Data List</a></li>
            <li><a href="#deskripsi" class="nav-link">Deskripsi Detail</a></li>
        </ul>
    </nav>

    <main class="main-content">
        <section id="dashboard" class="content-section active">
            <h1>Dashboard</h1>
            <div class="dashboard-grid">
                <div class="stat-card clickable" id="master-products-card">
                    <h3>Total Produk Master</h3>
                    <p class="stat-number" id="total-master-products">0</p>
                </div>
                <div class="stat-card">
                    <h3>Total Varian Unik</h3>
                    <p class="stat-number" id="total-unique-variants">0</p>
                </div>
                <div class="stat-card">
                    <h3>Total Stok Barang</h3>
                    <p class="stat-number" id="total-stock-items">0</p>
                </div>
                <div class="stat-card clickable" id="sold-items-card">
                    <h3>Barang Terjual</h3>
                    <p class="stat-number" id="total-items-sold">0</p>
                    <p class="stat-label">(30 Hari Terakhir)</p>
                </div>
                 <div class="stat-card">
                    <h3>Total Pendapatan</h3>
                    <p class="stat-number" id="total-revenue">Rp 0</p>
                    <p class="stat-label">(30 Hari Terakhir)</p>
                </div>
            </div>
            <div class="card" style="margin-top: 30px;">
                <h2>Produk Stok Menipis</h2>
                <div class="filter-container" style="margin-bottom: 15px; grid-template-columns: 1fr;">
                    <input type="text" id="low-stock-batch-filter" list="low-stock-batch-suggestions" placeholder="Filter berdasarkan batch...">
                    <datalist id="low-stock-batch-suggestions"></datalist>
                </div>
                <ul id="low-stock-list" class="low-stock-list">
                    </ul>
                <div id="low-stock-pagination-container">
                    </div>
            </div>
        </section>

        <section id="produk" class="content-section">
            <h1>Produk</h1>
            <div class="card">
                <h2>Buat / Edit Master Produk</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button id="save-master-btn" style="flex: 1;">Simpan Master Produk</button>
                    <button id="duplicate-master-btn" style="flex: 1; background-color: var(--dark-gray); color: white;">Duplikat</button>
                    <button id="delete-master-btn" style="flex: 1; background-color: var(--nippori-red); color: white;">Hapus Master</button>
                </div>
                <p>Langkah pertama: Buat atau edit detail utama produk di sini sebelum menambahkan varian.</p>
                <div class="form-group">
                    <label for="master-judul">Judul Produk</label>
                    <input type="text" id="master-judul" list="master-judul-suggestions" placeholder="Buat judul baru atau pilih yang sudah ada">
                    <datalist id="master-judul-suggestions"></datalist>
                </div>
                 <div class="form-group">
                    <label for="master-gambar">Gambar Utama</label>
                    <input type="file" id="master-gambar" accept="image/*">
                    <img id="master-gambar-preview" src="" alt="Preview Gambar Utama" style="max-width: 100px; margin-top: 10px; display: none;">
                </div>
                <div class="form-group">
                    <label for="master-kondisi">Kondisi</label>
                    <select id="master-kondisi">
                        <option value="New">New</option>
                        <option value="Open Box">Open Box</option>
                        <option value="Preloved (Used)">Preloved (Used)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="master-rilis">Rilis</label>
                    <input type="month" id="master-rilis">
                </div>
                <div class="form-group">
                    <label for="master-asal">Asal</label>
                    <input type="text" id="master-asal" placeholder="Contoh: Jepang">
                </div>
                <div class="form-group">
                    <label for="master-brand">Brand</label>
                    <input type="text" id="master-brand" list="brand-suggestions" placeholder="Contoh: Bandai">
                    <datalist id="brand-suggestions"></datalist>
                </div>
                <div class="form-group">
                    <label>Fitur Produk</label>
                    <div class="fitur-container">
                        <div class="fitur-item"><input type="checkbox" id="fitur-1" value="Original Jepang"><label for="fitur-1">Original Jepang</label></div>
                        <div class="fitur-item"><input type="checkbox" id="fitur-2" value="Detail Kualitas Tinggi"><label for="fitur-2">Detail Kualitas Tinggi</label></div>
                        <div class="fitur-item"><input type="checkbox" id="fitur-3" value="Include Line Up Paper"><label for="fitur-3">Include Line Up Paper</label></div>
                        <div class="fitur-item"><input type="checkbox" id="fitur-4" value="No Gacha Ball"><label for="fitur-4">No Gacha Ball</label></div>
                    </div>
                </div>
                 <div class="form-group">
                    <label for="master-keterangan">Keterangan (Opsional)</label>
                    <textarea id="master-keterangan" rows="3" placeholder="Catatan tambahan untuk produk ini..."></textarea>
                </div>
            </div>
        </section>

        <section id="data-list" class="content-section">
            <h1>Data List</h1>
            <div class="card">
                <h2>Input Varian</h2>
                <p>Langkah kedua: Pilih judul produk, lalu tambahkan varian-variannya di sini.</p>
                <div class="form-group">
                    <label for="judul-pilihan">Pilih Judul Produk</label>
                    <input type="text" id="judul-pilihan" list="judul-pilihan-suggestions" placeholder="Ketik untuk mencari judul...">
                    <datalist id="judul-pilihan-suggestions"></datalist>
                </div>
                <div class="form-group"><label for="total-variant">Jumlah Varian untuk Ditambahkan:</label><input type="number" id="total-variant" min="1"></div>
                <div class="form-group">
                    <label for="batch-month-picker">Bulan Barang Masuk</label>
                    <div class="batch-generator">
                        <input type="month" id="batch-month-picker">
                    </div>
                </div>
                <div class="form-group"><label for="batch-tag">Batch (Tag):</label><input type="text" id="batch-tag" placeholder="Kode batch akan dibuat otomatis..."><datalist id="batch-suggestions"></datalist></div>
                
                <div class="bulk-edit-container">
                    <h4>Ubah Massal (Opsional)</h4>
                    <div class="price-group">
                        <div class="form-group"><label>Harga Normal Massal:</label><input type="number" id="bulk-harga-normal" min="0"></div>
                        <div class="form-group"><label>Harga Diskon Massal:</label><input type="number" id="bulk-harga-diskon" min="0"></div>
                        <div class="form-group"><label>Stok Massal:</label><input type="number" id="bulk-stok" min="0"></div>
                    </div>
                </div>

                <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
                <div id="variant-inputs-container"></div>
                <button id="submit-variants-btn" style="display: none;">Simpan Semua Varian</button>
            </div>
            
            <div class="card product-list-card">
                 <h2>Daftar Semua Produk</h2>
                <div class="product-list-header">
                    <div class="filter-container">
                        <input type="text" id="search-input" placeholder="Cari berdasarkan judul, varian, batch, atau kode...">
                        <input type="text" id="batch-filter" list="batch-suggestions" placeholder="Filter berdasarkan batch...">
                        <select id="sort-filter">
                            <option value="desc">Urutkan: Terbaru</option>
                            <option value="asc">Urutkan: Terlama</option>
                        </select>
                    </div>
                    <div class="select-all-container">
                        <label for="select-all-filtered">Pilih Semua</label>
                        <input type="checkbox" id="select-all-filtered">
                    </div>
                    <div id="product-counts"></div>
                </div>
                <div id="product-list-container"></div>
                 <div id="pagination-container"></div>
                <div class="product-list-footer">
                    <div class="footer-actions-wrapper">
                        <div class="actions-container">
                            <button id="print-pdf-btn">Print ke PDF</button>
                            <button id="print-thermal-btn">Cetak Label Thermal</button>
                        </div>
                        <div class="actions-container">
                             <button id="download-images-btn">Unduh Gambar</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="deskripsi" class="content-section">
            <h1>Deskripsi Detail</h1>
            <div class="card">
                <h2>Generate Deskripsi untuk Shopee</h2>
                <p>Langkah ketiga: Pilih judul produk untuk membuat deskripsi lengkap yang siap disalin.</p>
                 <div class="form-group">
                    <label for="desc-judul-pilihan">Pilih Judul Produk</label>
                     <input type="text" id="desc-judul-pilihan" list="desc-judul-pilihan-suggestions" placeholder="Ketik untuk mencari judul...">
                     <datalist id="desc-judul-pilihan-suggestions"></datalist>
                </div>
                <textarea id="generated-description" readonly rows="15"></textarea>
                <br><br>
                <button id="copy-description-btn">Salin Deskripsi</button>
            </div>
        </section>
        
        <div id="image-popup" class="modal-overlay">
             <button id="image-popup-close" class="modal-close">&times;</button>
            <div class="modal-content"><img id="popup-img" src=""></div>
        </div>

        <div id="edit-modal" class="modal-overlay">
            <div class="modal-inner-content">
                <button id="edit-modal-close" class="modal-close">&times;</button>
                <h2>Edit Varian</h2>
                <input type="hidden" id="edit-uuid">
                 <div class="form-group">
                    <label for="edit-variant-name">Nama Varian</label>
                    <input type="text" id="edit-variant-name">
                </div>
                 <div class="price-group">
                    <div class="form-group"><label>Harga Normal:</label><input type="number" id="edit-harga-normal" min="0"></div>
                    <div class="form-group"><label>Harga Diskon:</label><input type="number" id="edit-harga-diskon" min="0"></div>
                </div>
                <div class="form-group">
                    <label for="edit-stok">Stok Baru</label>
                    <input type="number" id="edit-stok" min="0">
                </div>
                 <div class="form-group">
                    <label for="edit-stok-note-select">Catatan Perubahan Stok</label>
                    <select id="edit-stok-note-select">
                        <option value="Terjual">Terjual</option>
                        <option value="Barang Masuk">Barang Masuk</option>
                        <option value="Koreksi Manual">Koreksi Manual</option>
                        <option value="Retur">Retur</option>
                        <option value="Rusak">Rusak</option>
                        <option value="Lainnya">Lainnya...</option>
                    </select>
                </div>
                <div class="form-group" id="edit-stok-note-other-container" style="display: none;">
                    <label for="edit-stok-note-other">Catatan Lainnya</label>
                    <input type="text" id="edit-stok-note-other" placeholder="Masukkan catatan custom">
                </div>
                <hr>
                 <div class="form-group">
                    <label for="edit-batch">Batch</label>
                    <input type="text" id="edit-batch" list="batch-suggestions">
                </div>
                <div class="form-group">
                    <label for="edit-lokasi">Lokasi Fisik</label>
                    <input type="text" id="edit-lokasi">
                </div>
                <div class="form-group">
                    <label for="edit-batas-minimum">Batas Minimum Stok</label>
                    <input type="number" id="edit-batas-minimum" min="0">
                </div>
                 <div class="form-group">
                    <label for="edit-gambar-variant">Gambar Varian</label>
                    <input type="file" id="edit-gambar-variant" accept="image/*">
                    <img id="edit-gambar-preview" src="" style="max-width: 100px; margin-top: 10px;">
                </div>
                <button id="save-edit-btn">Simpan Perubahan</button>
            </div>
        </div>

        <div id="quick-add-modal" class="modal-overlay">
            <div class="modal-inner-content">
                 <button id="quick-add-modal-close" class="modal-close">&times;</button>
                 <h2 id="quick-add-title"></h2>
                 <input type="hidden" id="quick-add-judul">
                 <div class="form-group">
                     <label>Nama Varian (Pilih yang ada untuk restock, atau ketik baru)</label>
                     <input type="text" id="quick-add-variant-name" list="quick-add-variant-suggestions">
                     <datalist id="quick-add-variant-suggestions"></datalist>
                 </div>
                  <div class="price-group">
                    <div class="form-group"><label>Harga Normal:</label><input type="number" id="quick-add-harga-normal" min="0"></div>
                    <div class="form-group"><label>Harga Diskon:</label><input type="number" id="quick-add-harga-diskon" min="0"></div>
                </div>
                 <div class="form-group"><label>Jumlah Stok:</label><input type="number" id="quick-add-stok" min="1"></div>
                 <div class="form-group"><label>Batch (Opsional):</label><input type="text" id="quick-add-batch" list="batch-suggestions"></div>
                 <div class="form-group"><label>Gambar Varian (Opsional):</label><input type="file" id="quick-add-gambar" accept="image/*"></div>
                 <button id="quick-add-save-btn">Simpan</button>
            </div>
        </div>

        <div id="history-modal" class="modal-overlay">
             <div class="modal-inner-content">
                 <button id="history-modal-close" class="modal-close">&times;</button>
                 <h2 id="history-modal-title">Riwayat Stok</h2>
                 <ul id="history-modal-list"></ul>
             </div>
        </div>

        <div id="sold-items-modal" class="modal-overlay">
             <div class="modal-inner-content">
                 <button id="sold-items-modal-close" class="modal-close">&times;</button>
                 <h2>Riwayat Barang Terjual</h2>
                 <div id="sold-items-totals"></div>
                 <div class="filter-container">
                     <div class="form-group">
                         <label for="sold-start-date">Dari Tanggal</label>
                         <input type="date" id="sold-start-date">
                     </div>
                     <div class="form-group">
                         <label for="sold-end-date">Sampai Tanggal</label>
                         <input type="date" id="sold-end-date">
                     </div>
                 </div>
                 <ul id="sold-items-modal-list" class="sold-items-list"></ul>
             </div>
        </div>

        <div id="master-report-modal" class="modal-overlay">
            <div class="modal-inner-content">
                <button id="master-report-modal-close" class="modal-close">&times;</button>
                <h2>Laporan Produk Master</h2>
                <div class="filter-container">
                    <div class="form-group">
                        <label for="master-report-sort">Urutkan</label>
                        <select id="master-report-sort">
                            <option value="desc">Terbaru</option>
                            <option value="asc">Terlama</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="master-report-rilis-start">Rilis Dari</label>
                        <input type="month" id="master-report-rilis-start">
                    </div>
                    <div class="form-group">
                        <label for="master-report-rilis-end">Rilis Sampai</label>
                        <input type="month" id="master-report-rilis-end">
                    </div>
                </div>
                <ul id="master-report-modal-list" class="master-report-list"></ul>
            </div>
        </div>
        
        <div id="pdf-options-modal" class="modal-overlay">
            <div class="modal-inner-content">
                <button id="pdf-options-modal-close" class="modal-close">&times;</button>
                <h2>Pilih Data untuk Dicetak di PDF</h2>
                <div id="pdf-options-container">
                    <div class="fitur-item"><input type="checkbox" id="pdf-opt-gambar" checked><label for="pdf-opt-gambar">Gambar Varian</label></div>
                    <div class="fitur-item"><input type="checkbox" id="pdf-opt-kode" checked><label for="pdf-opt-kode">Kode Produk</label></div>
                    <div class="fitur-item"><input type="checkbox" id="pdf-opt-stok" checked><label for="pdf-opt-stok">Stok</label></div>
                    <div class="fitur-item"><input type="checkbox" id="pdf-opt-harga-normal" checked><label for="pdf-opt-harga-normal">Harga Normal</label></div>
                    <div class="fitur-item"><input type="checkbox" id="pdf-opt-harga-diskon" checked><label for="pdf-opt-harga-diskon">Harga Diskon</label></div>
                    <div class="fitur-item"><input type="checkbox" id="pdf-opt-persen-diskon" checked><label for="pdf-opt-persen-diskon">Persentase Diskon</label></div>
                    <div class="fitur-item"><input type="checkbox" id="pdf-opt-batch"><label for="pdf-opt-batch">Batch</label></div>
                    <div class="fitur-item"><input type="checkbox" id="pdf-opt-lokasi"><label for="pdf-opt-lokasi">Lokasi</label></div>
                </div>
                <br>
                <button id="generate-pdf-btn">Buat PDF</button>
            </div>
        </div>
         <div id="download-images-modal" class="modal-overlay">
            <div class="modal-inner-content">
                <button id="download-images-modal-close" class="modal-close">&times;</button>
                <h2>Unduh Gambar Terpilih</h2>
                <p>Klik link di bawah ini satu per satu untuk mengunduh gambar.</p>
                <ul id="download-links-list"></ul>
            </div>
        </div>
    </main>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Supabase Client & Configuration ---
        const supabaseUrl = 'https://gscvuwzqdywkbmyhohju.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdzY3Z1d3pxZHl3a2JteWhvaGp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3Mzc5NjgsImV4cCI6MjA3MjMxMzk2OH0.0TNw27sUI4BerA8qog9uPghdjjvcJ9wAgXIT79dkG7E';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // --- Data Stores (Supabase-driven now) ---
        let products = [];
        let productMasters = {};

        // --- State Variables ---
        let lowStockCurrentPage = 1;
        const lowStockItemsPerPage = 5;

        // --- Element Selectors ---
        const navLinks = document.querySelectorAll('.nav-link');
        const sections = document.querySelectorAll('.content-section');
        
        // Dashboard
        const totalMasterProductsEl = document.getElementById('total-master-products');
        const totalUniqueVariantsEl = document.getElementById('total-unique-variants');
        const totalStockItemsEl = document.getElementById('total-stock-items');
        const totalItemsSoldEl = document.getElementById('total-items-sold');
        const totalRevenueEl = document.getElementById('total-revenue');
        const lowStockListEl = document.getElementById('low-stock-list');
        const soldItemsCard = document.getElementById('sold-items-card');
        const masterProductsCard = document.getElementById('master-products-card');
        const lowStockBatchFilter = document.getElementById('low-stock-batch-filter');
        const lowStockBatchSuggestions = document.getElementById('low-stock-batch-suggestions');
        const lowStockPaginationContainer = document.getElementById('low-stock-pagination-container');

        // Section 1
        const masterJudulInput = document.getElementById('master-judul');
        const masterJudulSuggestions = document.getElementById('master-judul-suggestions');
        const masterGambarInput = document.getElementById('master-gambar');
        const masterGambarPreview = document.getElementById('master-gambar-preview');
        const masterKondisiSelect = document.getElementById('master-kondisi');
        const masterRilisInput = document.getElementById('master-rilis');
        const masterAsalInput = document.getElementById('master-asal');
        const masterBrandInput = document.getElementById('master-brand');
        const brandSuggestions = document.getElementById('brand-suggestions');
        const fiturCheckboxes = Array.from(document.querySelectorAll('[id^="fitur-"]'));
        const masterKeteranganInput = document.getElementById('master-keterangan');
        const saveMasterBtn = document.getElementById('save-master-btn');
        const duplicateMasterBtn = document.getElementById('duplicate-master-btn');
        const deleteMasterBtn = document.getElementById('delete-master-btn');

        // Section 2
        const judulPilihanInput = document.getElementById('judul-pilihan');
        const judulPilihanSuggestions = document.getElementById('judul-pilihan-suggestions');
        const totalVariantInput = document.getElementById('total-variant');
        const batchMonthPicker = document.getElementById('batch-month-picker');
        const batchTagInput = document.getElementById('batch-tag');
        const batchSuggestions = document.getElementById('batch-suggestions');
        const variantInputsContainer = document.getElementById('variant-inputs-container');
        const submitVariantsBtn = document.getElementById('submit-variants-btn');
        const productListContainer = document.getElementById('product-list-container');
        const searchInput = document.getElementById('search-input');
        const batchFilter = document.getElementById('batch-filter');
        const sortFilter = document.getElementById('sort-filter');
        const selectAllFilteredCheckbox = document.getElementById('select-all-filtered');
        const productCounts = document.getElementById('product-counts');
        const printPdfBtn = document.getElementById('print-pdf-btn');
        const printThermalBtn = document.getElementById('print-thermal-btn');
        const downloadImagesBtn = document.getElementById('download-images-btn');
        const bulkHargaNormalInput = document.getElementById('bulk-harga-normal');
        const bulkHargaDiskonInput = document.getElementById('bulk-harga-diskon');
        const bulkStokInput = document.getElementById('bulk-stok');
        
        // Section 3
        const descJudulPilihanInput = document.getElementById('desc-judul-pilihan');
        const descJudulPilihanSuggestions = document.getElementById('desc-judul-pilihan-suggestions');
        const generatedDescriptionTextarea = document.getElementById('generated-description');
        const copyDescriptionBtn = document.getElementById('copy-description-btn');
        
        // Modals & Popups
        const imagePopup = document.getElementById('image-popup');
        const popupImg = document.getElementById('popup-img');
        const imagePopupClose = document.getElementById('image-popup-close');
        
        const editModal = document.getElementById('edit-modal');
        const editModalClose = document.getElementById('edit-modal-close');
        const editUuidInput = document.getElementById('edit-uuid');
        const editVariantNameInput = document.getElementById('edit-variant-name');
        const editHargaNormalInput = document.getElementById('edit-harga-normal');
        const editHargaDiskonInput = document.getElementById('edit-harga-diskon');
        const editStokInput = document.getElementById('edit-stok');
        const editStokNoteSelect = document.getElementById('edit-stok-note-select');
        const editStokNoteOtherContainer = document.getElementById('edit-stok-note-other-container');
        const editStokNoteOtherInput = document.getElementById('edit-stok-note-other');
        const editBatchInput = document.getElementById('edit-batch');
        const editLokasiInput = document.getElementById('edit-lokasi');
        const editBatasMinimumInput = document.getElementById('edit-batas-minimum');
        const editGambarVariantInput = document.getElementById('edit-gambar-variant');
        const editGambarPreview = document.getElementById('edit-gambar-preview');
        const saveEditBtn = document.getElementById('save-edit-btn');
        
        const quickAddModal = document.getElementById('quick-add-modal');
        const quickAddModalClose = document.getElementById('quick-add-modal-close');
        const quickAddTitle = document.getElementById('quick-add-title');
        const quickAddJudulInput = document.getElementById('quick-add-judul');
        const quickAddVariantNameInput = document.getElementById('quick-add-variant-name');
        const quickAddVariantSuggestions = document.getElementById('quick-add-variant-suggestions');
        const quickAddStokInput = document.getElementById('quick-add-stok');
        const quickAddBatchInput = document.getElementById('quick-add-batch');
        const quickAddHargaNormalInput = document.getElementById('quick-add-harga-normal');
        const quickAddHargaDiskonInput = document.getElementById('quick-add-harga-diskon');
        const quickAddGambarInput = document.getElementById('quick-add-gambar');
        const quickAddSaveBtn = document.getElementById('quick-add-save-btn');

        const historyModal = document.getElementById('history-modal');
        const historyModalClose = document.getElementById('history-modal-close');
        const historyModalTitle = document.getElementById('history-modal-title');
        const historyModalList = document.getElementById('history-modal-list');

        const soldItemsModal = document.getElementById('sold-items-modal');
        const soldItemsModalClose = document.getElementById('sold-items-modal-close');
        const soldItemsModalList = document.getElementById('sold-items-modal-list');
        const soldStartDateInput = document.getElementById('sold-start-date');
        const soldEndDateInput = document.getElementById('sold-end-date');
        const soldItemsTotalsEl = document.getElementById('sold-items-totals');

        const masterReportModal = document.getElementById('master-report-modal');
        const masterReportModalClose = document.getElementById('master-report-modal-close');
        const masterReportModalList = document.getElementById('master-report-modal-list');
        const masterReportSort = document.getElementById('master-report-sort');
        const masterReportRilisStart = document.getElementById('master-report-rilis-start');
        const masterReportRilisEnd = document.getElementById('master-report-rilis-end');
        
        const pdfOptionsModal = document.getElementById('pdf-options-modal');
        const pdfOptionsModalClose = document.getElementById('pdf-options-modal-close');
        const generatePdfBtn = document.getElementById('generate-pdf-btn');

        const downloadImagesModal = document.getElementById('download-images-modal');
        const downloadImagesModalClose = document.getElementById('download-images-modal-close');
        const downloadLinksList = document.getElementById('download-links-list');
        
        // --- Notification System ---
        const notificationContainer = document.createElement('div');
        notificationContainer.id = 'notification-container';
        document.body.appendChild(notificationContainer);

        function showNotification(message, type = 'success') {
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.textContent = message;

            notificationContainer.appendChild(notif);
            
            setTimeout(() => {
                notif.classList.add('show');
            }, 10);

            setTimeout(() => {
                notif.classList.remove('show');
                notif.addEventListener('transitionend', () => notif.remove());
            }, 3000);
        }
        
        // --- Core Functions ---
        // Function to upload image to Supabase Storage and get public URL
        async function uploadImageAndGetUrl(file) {
            if (!file) return null;
            const fileName = `${Date.now()}-${file.name.replace(/ /g, '_')}`;
            const { data, error } = await supabase.storage
                .from('nippori-images') // GANTI NAMA BUCKET JIKA PERLU
                .upload(`public/${fileName}`, file);

            if (error) {
                console.error("Gagal mengunggah gambar:", error);
                return null;
            }

            const { data: publicUrlData } = supabase.storage
                .from('nippori-images')
                .getPublicUrl(data.path);

            return publicUrlData.publicUrl;
        }

        const fetchAllData = async () => {
            showNotification('Memuat data dari Supabase...', 'info');
            
            // Ambil data masters
            const { data: masters, error: mastersError } = await supabase
                .from('product_masters')
                .select('*');
            if (mastersError) { 
                console.error('Gagal memuat master data:', mastersError);
                showNotification('Gagal memuat data master.', 'error');
                return;
            }
            
            productMasters = masters.reduce((acc, master) => {
                acc[master.judul] = { ...master.data, titleUuid: master.id };
                return acc;
            }, {});

            // Ambil data variants
            const { data: variants, error: variantsError } = await supabase
                .from('variants')
                .select('*');
            if (variantsError) { 
                console.error('Gagal memuat varian data:', variantsError); 
                showNotification('Gagal memuat data varian.', 'error');
                return;
            }

            products = variants.map(v => ({
                uuid: v.id,
                titleUuid: v.judul_id,
                judul: masters.find(m => m.id === v.judul_id)?.judul || 'Unknown',
                ...v.data
            }));
            
            filterAndRenderAll();
            showNotification('Data berhasil dimuat.');
        };

        const populateMasterForm = (judul) => {
            const masterData = productMasters[judul]?.data;
            if (!masterData) {
                masterGambarInput.value = '';
                masterGambarPreview.src = '';
                masterGambarPreview.style.display = 'none';
                masterKondisiSelect.value = 'New';
                masterRilisInput.value = '';
                masterAsalInput.value = 'Jepang';
                masterBrandInput.value = 'Bandai';
                fiturCheckboxes.forEach(cb => cb.checked = true);
                masterKeteranganInput.value = '';
                return;
            };
            masterGambarInput.value = '';
            masterGambarPreview.src = masterData.gambar || '';
            masterGambarPreview.style.display = masterData.gambar ? 'block' : 'none';
            masterKondisiSelect.value = masterData.kondisi || 'New';
            masterRilisInput.value = masterData.rilis || '';
            masterAsalInput.value = masterData.asal || '';
            masterBrandInput.value = masterData.brand || '';
            masterKeteranganInput.value = masterData.keterangan || '';
            fiturCheckboxes.forEach(cb => {
                cb.checked = (masterData.fitur || []).includes(cb.value);
            });
        };
        
        const updateAllSuggestions = () => {
            const titles = Object.entries(productMasters)
                .sort(([,a],[,b]) => (b.lastModified || 0) - (a.lastModified || 0))
                .map(([title]) => title);

            const titleOptions = titles.map(t => `<option value="${t}"></option>`).join('');
            masterJudulSuggestions.innerHTML = titleOptions;
            judulPilihanSuggestions.innerHTML = titleOptions;
            descJudulPilihanSuggestions.innerHTML = titleOptions;
            
            const uniqueBrands = [...new Set(Object.values(productMasters).map(m => m.data.brand).filter(Boolean))];
            brandSuggestions.innerHTML = uniqueBrands.map(b => `<option value="${b}"></option>`).join('');

            const uniqueBatches = [...new Set(products.map(p => p.data.batchTag).filter(Boolean))];
            batchSuggestions.innerHTML = uniqueBatches.map(b => `<option value="${b}"></option>`).join('');
        };

        const generateKode = (titleUuid, variantName) => {
            const uniqueId = String(titleUuid).slice(-4).padStart(4, '0');
            return `${uniqueId}-${variantName.trim()}`;
        }
        
        const updateCounts = () => {
            const totalVariants = products.length;
            const displayedVariants = productListContainer.querySelectorAll('.variant-item').length;
            const selectedVariants = productListContainer.querySelectorAll('.variant-checkbox:checked').length;
            productCounts.innerHTML = `Total Varian: <strong>${totalVariants}</strong> | Ditampilkan: <strong>${displayedVariants}</strong> | Dipilih: <strong>${selectedVariants}</strong>`;
        };
        
        const getFilteredAndSortedProducts = () => {
            let productsToRender = [...products];
            const searchTerm = searchInput.value.toLowerCase();
            const selectedBatch = batchFilter.value;
            const sortOrder = sortFilter.value;

            productsToRender.sort((a, b) => sortOrder === 'asc' ? a.data.lastModified - b.data.lastModified : b.data.lastModified - a.data.lastModified);

            if (selectedBatch) {
                productsToRender = productsToRender.filter(p => p.data.batchTag === selectedBatch);
            }

            if (searchTerm) {
                productsToRender = productsToRender.filter(p => 
                    (p.judul.toLowerCase().includes(searchTerm)) ||
                    (p.data.variant.toLowerCase().includes(searchTerm)) ||
                    (p.data.kode && p.data.kode.toLowerCase().includes(searchTerm)) ||
                    (p.data.batchTag && p.data.batchTag.toLowerCase().includes(searchTerm))
                );
            }
            return productsToRender;
        };
        
        function renderLowStockSection() {
            let lowStockProducts = products.filter(p => (p.data.stok || 0) <= (p.data.batasMinimum || 0));

            const uniqueBatches = [...new Set(lowStockProducts.map(p => p.data.batchTag).filter(Boolean))];
            lowStockBatchSuggestions.innerHTML = uniqueBatches.map(b => `<option value="${b}"></option>`).join('');

            const selectedBatch = lowStockBatchFilter.value;
            if (selectedBatch) {
                lowStockProducts = lowStockProducts.filter(p => p.data.batchTag === selectedBatch);
            }
            
            lowStockProducts.sort((a, b) => a.data.stok - b.data.stok);

            const totalPages = Math.ceil(lowStockProducts.length / lowStockItemsPerPage);
            const startIndex = (lowStockCurrentPage - 1) * lowStockItemsPerPage;
            const paginatedItems = lowStockProducts.slice(startIndex, startIndex + lowStockItemsPerPage);

            if (paginatedItems.length > 0) {
                lowStockListEl.innerHTML = paginatedItems.map((p, index) => {
                    const itemNumber = startIndex + index + 1;
                    const placeholderImg = 'https://placehold.co/40x40/e0e0e0/555?text=...';
                    return `<li data-uuid="${p.uuid}"> 
                                <div class="low-stock-details">
                                    <span style="min-width: 25px; text-align: right; margin-right: 5px;">${itemNumber}.</span>
                                    <img src="${p.data.gambar || placeholderImg}" class="low-stock-image image-preview-trigger" data-img-src="${p.data.gambar || ''}">
                                    <div>
                                        <strong class="low-stock-link" style="cursor: pointer; color: var(--nippori-blue);">${p.judul} - ${p.data.variant}</strong>
                                        <span>(Stok: ${p.data.stok})</span>
                                    </div>
                                </div>
                                <div class="low-stock-actions">
                                    <button class="action-btn edit-btn" data-uuid="${p.uuid}">Edit</button>
                                    <button class="action-btn delete-btn" data-uuid="${p.uuid}">Hapus</button>
                                </div>
                            </li>`;
                }).join('');
            } else {
                lowStockListEl.innerHTML = '<li>Tidak ada produk stok menipis yang cocok.</li>';
            }

            lowStockPaginationContainer.innerHTML = '';
            if (totalPages > 1) {
                for (let i = 1; i <= totalPages; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.textContent = i;
                    pageBtn.className = `page-btn ${i === lowStockCurrentPage ? 'active' : ''}`;
                    pageBtn.dataset.page = i;
                    lowStockPaginationContainer.appendChild(pageBtn);
                }
            }
        }
        
        const renderDashboard = () => {
            let totalSoldLast30Days = 0;
            let totalRevenueLast30Days = 0;
            const thirtyDaysAgo = new Date().setDate(new Date().getDate() - 30);

            products.forEach(p => {
                if(p.data.history) {
                    p.data.history.forEach(h => {
                        if (h.itemsSold && new Date(h.date) > thirtyDaysAgo) {
                            totalSoldLast30Days += h.itemsSold;
                            totalRevenueLast30Days += h.revenue;
                        }
                    });
                }
            });

            totalMasterProductsEl.textContent = Object.keys(productMasters).length;
            totalUniqueVariantsEl.textContent = products.length;
            totalStockItemsEl.textContent = products.reduce((sum, p) => sum + (p.data.stok || 0), 0);
            totalItemsSoldEl.textContent = totalSoldLast30Days;
            totalRevenueEl.textContent = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(totalRevenueLast30Days);
            
            renderLowStockSection();
        };

        const renderProductList = () => {
            const filteredProducts = getFilteredAndSortedProducts();
            const groupedByBatch = filteredProducts.reduce((acc, p) => {
                const batchKey = p.data.batchTag || 'Tanpa Batch';
                if (!acc[batchKey]) acc[batchKey] = {};
                if (!acc[batchKey][p.judul]) acc[batchKey][p.judul] = [];
                acc[batchKey][p.judul].push(p);
                return acc;
            }, {});

            const paginatedBatches = Object.keys(groupedByBatch); 
            
            productListContainer.innerHTML = '';

            paginatedBatches.forEach(batch => {
                const batchContainer = document.createElement('div');
                batchContainer.innerHTML = `<h2 class="batch-header">Batch: ${batch}</h2>`;
                
                const productsInBatch = groupedByBatch[batch];
                for (const judul in productsInBatch) {
                     const master = productMasters[judul]?.data || {};
                    const variants = productsInBatch[judul];
                    const groupCard = document.createElement('div');
                    groupCard.className = 'product-group-card';
                    
                    let variantsHTML = '';
                    variants.forEach(v => {
                        const lowStockClass = (v.data.stok <= (v.data.batasMinimum || 0)) ? 'low-stock' : '';
                        let priceHTML = `<div class="price-display"><strong>${new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(v.data.hargaNormal || 0)}</strong></div>`;
                        if (v.data.hargaDiskon > 0 && v.data.hargaDiskon < v.data.hargaNormal) {
                            const diskon = Math.round(((v.data.hargaNormal - v.data.hargaDiskon) / v.data.hargaNormal) * 100);
                            priceHTML = `<div class="price-display"><span class="price-diskon">${new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(v.data.hargaDiskon)}</span><span class="price-normal">${new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(v.data.hargaNormal)}</span><span class="diskon-badge">${diskon}%</span></div>`;
                        }

                        variantsHTML += `
                            <li class="variant-item ${lowStockClass}" data-uuid="${v.uuid}">
                                <img src="${v.data.gambar || 'https://placehold.co/40x40/e0e0e0/555?text=...'}" class="variant-image image-preview-trigger" data-img-src="${v.data.gambar || ''}">
                                <div class="variant-details">
                                    <p><strong>${v.data.variant}</strong></p>
                                    ${priceHTML}
                                    <p>Stok: ${v.data.stok} | Lokasi: ${v.data.lokasi || '-'}</p>
                                    <p style="font-size: 0.8em; color: #6c757d;">Kode: ${v.data.kode || 'N/A'}</p>
                                </div>
                                <div class="variant-actions">
                                    <button class="action-btn history-btn">Riwayat</button>
                                    <button class="action-btn edit-btn">Edit</button>
                                    <button class="action-btn delete-btn">Hapus</button>
                                    <input type="checkbox" class="variant-checkbox">
                                </div>
                            </li>
                        `;
                    });

                    groupCard.innerHTML = `
                        <div class="group-header">
                            <img src="${master.gambar || 'https://placehold.co/60x60/e0e0e0/555?text=NoImg'}" class="group-image image-preview-trigger" data-img-src="${master.gambar || ''}">
                            <div class="group-title">${judul}</div>
                            <span class="group-toggle-icon">&#9654;</span>
                            <button class="action-btn quick-add-btn" data-judul="${judul}">+</button>
                            <button class="action-btn delete-btn group-delete-btn" data-judul="${judul}">Hapus Grup</button>
                            <input type="checkbox" class="group-checkbox">
                        </div>
                        <ul class="variant-list">${variantsHTML}</ul>
                    `;
                    batchContainer.appendChild(groupCard)
                }
                productListContainer.appendChild(batchContainer);
            });
            updateCounts();
        };

        const filterAndRenderAll = () => {
            const activeSectionId = document.querySelector('.content-section.active')?.id;
            if (activeSectionId === 'dashboard') {
                renderDashboard();
            } else if (activeSectionId === 'data-list') {
                renderProductList();
            }
            updateAllSuggestions();
        };

        // --- Event Listeners ---
        [searchInput, batchFilter, sortFilter].forEach(el => el.addEventListener('input', filterAndRenderAll));
        
        // --- Initial Check and Load ---
        fetchAllData();

        // --- Navigation Logic ---
        navLinks.forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);
                navLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                sections.forEach(s => s.classList.toggle('active', s.id === targetId));
                filterAndRenderAll();
            });
        });

        // MENU 1: MASTER PRODUK
        masterJudulInput.addEventListener('input', () => {
            populateMasterForm(masterJudulInput.value);
        });

        masterGambarInput.addEventListener('change', () => {
            if(masterGambarInput.files[0]) {
                 masterGambarPreview.src = URL.createObjectURL(masterGambarInput.files[0]);
                 masterGambarPreview.style.display = 'block';
            }
        });

        saveMasterBtn.addEventListener('click', async () => {
            const judul = masterJudulInput.value.trim();
            if (!judul) {
                showNotification('Judul produk tidak boleh kosong.', 'error');
                return;
            }

            const existingData = productMasters[judul]?.data || {};
            const existingId = productMasters[judul]?.titleUuid || null;
            const selectedFeatures = fiturCheckboxes.filter(cb => cb.checked).map(cb => cb.value);

            let imageUrl = existingData.gambar || null;
            if (masterGambarInput.files[0]) {
                 imageUrl = await uploadImageAndGetUrl(masterGambarInput.files[0]);
                 if (!imageUrl) {
                    showNotification('Gagal mengunggah gambar.', 'error');
                    return;
                }
            }

            const masterData = {
                gambar: imageUrl,
                kondisi: masterKondisiSelect.value,
                rilis: masterRilisInput.value,
                asal: masterAsalInput.value,
                brand: masterBrandInput.value,
                fitur: selectedFeatures,
                keterangan: masterKeteranganInput.value.trim(),
                createdAt: existingData.createdAt || new Date().toISOString(),
                lastModified: new Date().toISOString()
            };

            const upsertData = {
                id: existingId,
                judul,
                data: masterData
            };
            
            const { data, error } = await supabase
                .from('product_masters')
                .upsert(upsertData)
                .select();
            
            if (error) {
                console.error("Supabase error:", error);
                showNotification('Gagal menyimpan master produk: ' + error.message, 'error');
            } else {
                productMasters[judul] = { ...masterData, titleUuid: data[0].id };
                showNotification(`Master produk "${judul}" berhasil disimpan!`);
                updateAllSuggestions();
                masterJudulInput.value = '';
                populateMasterForm('');
            }
        });
        
        deleteMasterBtn.addEventListener('click', async () => {
            const judul = masterJudulInput.value.trim();
            if (!judul || !productMasters[judul]) {
                showNotification('Pilih master produk yang ingin dihapus terlebih dahulu.', 'error');
                return;
            }

            if (confirm(`Yakin ingin menghapus master produk "${judul}"? INI AKAN MENGHAPUS SEMUA VARIANNYA JUGA.`)) {
                const titleUuid = productMasters[judul].titleUuid;
                
                const { error: variantError } = await supabase
                    .from('variants')
                    .delete()
                    .eq('judul_id', titleUuid);

                if (variantError) {
                    console.error("Supabase error:", variantError);
                    showNotification('Gagal menghapus varian terkait: ' + variantError.message, 'error');
                    return;
                }

                const { error: masterError } = await supabase
                    .from('product_masters')
                    .delete()
                    .eq('id', titleUuid);
                
                if (masterError) {
                    console.error("Supabase error:", masterError);
                    showNotification('Gagal menghapus master produk: ' + masterError.message, 'error');
                    return;
                }

                delete productMasters[judul];
                products = products.filter(p => p.judul !== judul);

                showNotification(`Master produk "${judul}" dan semua variannya telah dihapus.`);
                masterJudulInput.value = '';
                populateMasterForm(''); 
                filterAndRenderAll();
            }
        });
        
        duplicateMasterBtn.addEventListener('click', () => {
            if (!masterJudulInput.value) {
                showNotification("Pilih atau isi data master produk yang ingin diduplikasi terlebih dahulu.", 'error');
                return;
            }
            masterJudulInput.value = "";
            masterJudulInput.placeholder = "Masukkan judul baru untuk duplikat...";
            masterJudulInput.focus();
            showNotification("Data telah diduplikasi. Masukkan judul baru lalu simpan.", 'info');
        });

        // MENU 2: INPUT VARIAN
        [bulkHargaNormalInput, bulkHargaDiskonInput, bulkStokInput].forEach(bulkInput => {
            bulkInput.addEventListener('input', () => {
                const variantGroups = variantInputsContainer.querySelectorAll('.variant-input-group');
                variantGroups.forEach(group => {
                    if (bulkInput.id === 'bulk-harga-normal' && bulkInput.value) {
                        group.querySelector('.variant-harga-normal').value = bulkInput.value;
                    }
                    if (bulkInput.id === 'bulk-harga-diskon' && bulkInput.value) {
                        group.querySelector('.variant-harga-diskon').value = bulkInput.value;
                    }
                    if (bulkInput.id === 'bulk-stok' && bulkInput.value) {
                        group.querySelector('.variant-stok').value = bulkInput.value;
                    }
                    const normalInput = group.querySelector('.variant-harga-normal');
                    normalInput.dispatchEvent(new Event('input'));
                });
            });
        });

        batchMonthPicker.addEventListener('change', () => {
            const monthValue = batchMonthPicker.value;
            if (!monthValue) return;

            const [year, month] = monthValue.split('-');
            const baseCode = `${year}${month}`;
            
            const existingBatches = products
                .map(p => p.data.batchTag)
                .filter(b => b && b.startsWith(baseCode));
            
            let nextNum = 1;
            if (existingBatches.length > 0) {
                const highestNum = existingBatches
                    .map(b => parseInt(b.split('-')[1]) || 0)
                    .reduce((max, num) => Math.max(max, num), 0);
                nextNum = highestNum + 1;
            }

            batchTagInput.value = `${baseCode}-${String(nextNum).padStart(2, '0')}`;
        });

        totalVariantInput.addEventListener('input', () => {
            const count = parseInt(totalVariantInput.value, 10) || 0;
            variantInputsContainer.innerHTML = '';
            if (count > 0) {
                for (let i = 0; i < count; i++) {
                    const group = document.createElement('div');
                    group.className = 'variant-input-group';
                    group.innerHTML = `
                        <h3>Varian ${i + 1}</h3>
                        <div class="form-group"><label>Nama Varian:</label><input type="text" class="variant-name"></div>
                        <div class="price-group">
                            <div class="form-group"><label>Harga Normal:</label><input type="number" class="variant-harga-normal" min="0"></div>
                            <div class="form-group"><label>Harga Diskon:</label><input type="number" class="variant-harga-diskon" min="0"></div>
                        </div>
                        <div class="discount-preview"></div>
                        <div class="form-group"><label>Stok Awal:</label><input type="number" class="variant-stok" min="0"></div>
                        <div class="form-group"><label>Batas Minimum Stok:</label><input type="number" class="variant-batas-minimum" min="0" value="0"></div>
                        <div class="form-group"><label>Lokasi Fisik:</label><input type="text" class="variant-lokasi" placeholder="Contoh: Rak A-01"></div>
                        <div class="form-group"><label>Gambar Varian:</label><input type="file" class="variant-gambar" accept="image/*"></div>
                    `;
                    variantInputsContainer.appendChild(group);
                }
                variantInputsContainer.querySelectorAll('.variant-harga-normal, .variant-harga-diskon').forEach(el => {
                    el.addEventListener('input', (e) => {
                        const group = e.target.closest('.variant-input-group');
                        const normalInput = group.querySelector('.variant-harga-normal');
                        const diskonInput = group.querySelector('.variant-harga-diskon');
                        const previewEl = group.querySelector('.discount-preview');
                        const normal = parseFloat(normalInput.value);
                        const diskon = parseFloat(diskonInput.value);
                        if (normal > 0 && diskon > 0 && diskon < normal) {
                            const percentage = Math.round(((normal - diskon) / normal) * 100);
                            previewEl.textContent = `Diskon ${percentage}%`;
                        } else {
                            previewEl.textContent = '';
                        }
                    });
                });
                submitVariantsBtn.style.display = 'block';
            } else {
                submitVariantsBtn.style.display = 'none';
            }
        });

        submitVariantsBtn.addEventListener('click', async () => {
            const judul = judulPilihanInput.value;
            const batch = batchTagInput.value.trim();
            if (!judul) { showNotification('Silakan pilih judul produk terlebih dahulu.', 'error'); return; }
            
            const master = productMasters[judul];
            if (!master || !master.titleUuid) { 
                showNotification('Master produk tidak valid. Harap simpan master produk terlebih dahulu.', 'error'); 
                return; 
            }
            const titleUuid = master.titleUuid;

            const variantGroups = variantInputsContainer.querySelectorAll('.variant-input-group');
            const variantsToInsert = [];
            
            for (const group of variantGroups) {
                const variantName = group.querySelector('.variant-name').value.trim();
                if (!variantName) continue; 

                const stok = parseInt(group.querySelector('.variant-stok').value) || 0;
                const hargaNormal = parseFloat(group.querySelector('.variant-harga-normal').value) || 0;
                const hargaDiskon = parseFloat(group.querySelector('.variant-harga-diskon').value) || 0;
                const batasMinimum = parseInt(group.querySelector('.variant-batas-minimum').value) || 0;
                const lokasi = group.querySelector('.variant-lokasi').value.trim();
                const gambarInput = group.querySelector('.variant-gambar');

                const gambarUrl = await uploadImageAndGetUrl(gambarInput.files[0]);

                variantsToInsert.push({
                    judul_id: titleUuid,
                    data: {
                        variant: variantName, 
                        stok, 
                        batchTag: batch,
                        gambar: gambarUrl,
                        kode: generateKode(titleUuid, variantName),
                        lokasi, batasMinimum, hargaNormal, hargaDiskon,
                        history: [{ date: new Date().toISOString(), note: 'Stok Awal', change: stok }],
                        lastModified: new Date().toISOString()
                    }
                });
            }

            if (variantsToInsert.length > 0) {
                const { data, error } = await supabase.from('variants').insert(variantsToInsert).select();
                
                if(error) {
                    console.error("Supabase error:", error);
                    showNotification('Gagal menyimpan varian: ' + error.message, 'error');
                } else {
                    await fetchAllData();
                    showNotification(`${data.length} varian baru ditambahkan!`);
                    totalVariantInput.value = '';
                    variantInputsContainer.innerHTML = '';
                    submitVariantsBtn.style.display = 'none';
                }
            } else {
                showNotification('Tidak ada varian valid untuk disimpan. Pastikan nama varian diisi.', 'error');
            }
        });
        
        // Data List Actions
        productListContainer.addEventListener('click', (e) => {
            const target = e.target;

            if (target.closest('.group-header') && !target.matches('button, input')) {
                 target.closest('.product-group-card').classList.toggle('expanded');
                 return;
            }
            
            if (target.matches('.image-preview-trigger, .group-image, .variant-image')) {
                const imgSrc = target.dataset.imgSrc;
                if(imgSrc) {
                    popupImg.src = imgSrc;
                    imagePopup.style.display = 'flex';
                }
                return;
            }
            
            if(target.matches('.quick-add-btn')) {
                const judul = target.dataset.judul;
                quickAddJudulInput.value = judul;
                quickAddTitle.textContent = `Tambah/Restock Varian ke "${judul}"`;

                const existingVariants = products.filter(p => p.judul === judul).map(p => `<option value="${p.data.variant}"></option>`).join('');
                quickAddVariantSuggestions.innerHTML = existingVariants;
                
                quickAddModal.style.display = 'flex';
                return;
            }

            if(target.matches('.group-delete-btn')) {
                const judul = target.dataset.judul;
                if (confirm(`Yakin ingin menghapus grup "${judul}" dan semua variannya?`)) {
                    const titleUuid = productMasters[judul].titleUuid;
                    
                    supabase.from('variants').delete().eq('judul_id', titleUuid)
                        .then(() => supabase.from('product_masters').delete().eq('id', titleUuid))
                        .then(() => {
                            delete productMasters[judul];
                            products = products.filter(p => p.judul !== judul);
                            fetchAllData();
                            showNotification(`Grup "${judul}" telah dihapus.`);
                        }).catch(error => {
                            console.error("Supabase error:", error);
                            showNotification('Gagal menghapus grup.', 'error');
                        });
                }
                return;
            }

            if(target.matches('.group-checkbox')) {
                const groupCard = target.closest('.product-group-card');
                const variantCheckboxes = groupCard.querySelectorAll('.variant-checkbox');
                variantCheckboxes.forEach(cb => cb.checked = target.checked);
                updateCounts();
                return;
            }
            
            if(target.matches('.variant-checkbox')) {
                updateCounts();
                return;
            }

            const variantItem = target.closest('.variant-item');
            if (!variantItem) return;
            
            const uuid = variantItem.dataset.uuid;

            if (target.classList.contains('delete-btn')) {
                if (confirm('Yakin ingin menghapus varian ini?')) {
                    supabase.from('variants').delete().eq('id', uuid)
                        .then(() => {
                            products = products.filter(p => p.uuid !== uuid);
                            fetchAllData();
                            showNotification('Varian berhasil dihapus.');
                        }).catch(error => {
                            console.error("Supabase error:", error);
                            showNotification('Gagal menghapus varian.', 'error');
                        });
                }
            }

            if (target.classList.contains('edit-btn')) {
                const productToEdit = products.find(p => p.uuid === uuid);
                if (productToEdit) {
                    editUuidInput.value = productToEdit.uuid;
                    editVariantNameInput.value = productToEdit.data.variant;
                    editHargaNormalInput.value = productToEdit.data.hargaNormal || 0;
                    editHargaDiskonInput.value = productToEdit.data.hargaDiskon || 0;
                    editStokInput.value = productToEdit.data.stok;
                    editBatchInput.value = productToEdit.data.batchTag || '';
                    editGambarPreview.src = productToEdit.data.gambar || '';
                    editGambarVariantInput.value = '';
                    editLokasiInput.value = productToEdit.data.lokasi || '';
                    editBatasMinimumInput.value = productToEdit.data.batasMinimum || 0;
                    editStokNoteSelect.value = 'Koreksi Manual';
                    editStokNoteOtherContainer.style.display = 'none';
                    editStokNoteOtherInput.value = '';
                    editModal.style.display = 'flex';
                }
            }
            
            if (target.classList.contains('history-btn')) {
                const product = products.find(p => p.uuid === uuid);
                if (product) {
                    historyModalTitle.textContent = `Riwayat Stok: ${product.data.variant}`;
                    if (product.data.history && product.data.history.length > 0) {
                        historyModalList.innerHTML = product.data.history.slice().reverse().map(item => {
                            const changeClass = item.change >= 0 ? 'change-plus' : 'change-minus';
                            const changeSign = item.change >= 0 ? '+' : '';
                            return `<li>
                                        <span>${new Date(item.date).toLocaleString('id-ID')} - ${item.note}</span>
                                        <strong class="${changeClass}">${changeSign}${item.change}</strong>
                                    </li>`;
                        }).join('');
                    } else {
                        historyModalList.innerHTML = '<li>Tidak ada riwayat.</li>';
                    }
                    historyModal.style.display = 'flex';
                }
            }
        });

        selectAllFilteredCheckbox.addEventListener('change', (e) => {
            const checkboxes = productListContainer.querySelectorAll('.variant-checkbox, .group-checkbox');
            checkboxes.forEach(cb => cb.checked = e.target.checked);
            updateCounts();
        });
        
        editStokNoteSelect.addEventListener('change', () => {
            editStokNoteOtherContainer.style.display = (editStokNoteSelect.value === 'Lainnya') ? 'block' : 'none';
        });

        saveEditBtn.addEventListener('click', async () => {
            const uuid = editUuidInput.value;
            const productIndex = products.findIndex(p => p.uuid === uuid);
            if (productIndex > -1) {
                const oldStok = products[productIndex].data.stok;
                const newStok = parseInt(editStokInput.value) || 0;
                const stokChange = newStok - oldStok;
                
                let note = editStokNoteSelect.value;
                if (note === 'Lainnya') {
                    note = editStokNoteOtherInput.value.trim();
                }

                const updatedData = { ...products[productIndex].data };
                
                if (stokChange !== 0) {
                    const historyEntry = {
                        date: new Date().toISOString(),
                        note: note || 'Koreksi Manual',
                        change: stokChange
                    };

                    if (stokChange < 0 && (note.toLowerCase().includes('jual') || note.toLowerCase().includes('terjual') || note.toLowerCase().includes('order'))) {
                        const sellingPrice = (updatedData.hargaDiskon > 0 && updatedData.hargaDiskon < updatedData.hargaNormal) ? updatedData.hargaDiskon : updatedData.hargaNormal;
                        historyEntry.itemsSold = Math.abs(stokChange);
                        historyEntry.revenue = historyEntry.itemsSold * sellingPrice;
                    }

                    updatedData.history = updatedData.history || [];
                    updatedData.history.push(historyEntry);
                }
                
                updatedData.variant = editVariantNameInput.value.trim();
                updatedData.hargaNormal = parseFloat(editHargaNormalInput.value) || 0;
                updatedData.hargaDiskon = parseFloat(editHargaDiskonInput.value) || 0;
                updatedData.stok = newStok;
                updatedData.batchTag = editBatchInput.value.trim();
                updatedData.lokasi = editLokasiInput.value.trim();
                updatedData.batasMinimum = parseInt(editBatasMinimumInput.value) || 0;
                updatedData.lastModified = new Date().toISOString();
                
                if (editGambarVariantInput.files[0]) {
                    updatedData.gambar = await uploadImageAndGetUrl(editGambarVariantInput.files[0]);
                }

                const { error } = await supabase
                    .from('variants')
                    .update({ data: updatedData })
                    .eq('id', uuid);

                if(error) {
                    console.error("Supabase error:", error);
                    showNotification('Gagal menyimpan perubahan: ' + error.message, 'error');
                } else {
                    await fetchAllData();
                    editModal.style.display = 'none';
                    showNotification('Perubahan berhasil disimpan.');
                }
            }
        });
        
        quickAddSaveBtn.addEventListener('click', async () => {
            const judul = quickAddJudulInput.value;
            const variantName = quickAddVariantNameInput.value.trim();
            const stokToAdd = parseInt(quickAddStokInput.value) || 0;
            const batch = quickAddBatchInput.value.trim();
            const hargaNormal = parseFloat(quickAddHargaNormalInput.value) || 0;
            const hargaDiskon = parseFloat(quickAddHargaDiskonInput.value) || 0;

            if (!variantName || !judul || stokToAdd <= 0) {
                showNotification("Nama varian dan jumlah stok harus diisi.", 'error');
                return;
            }

            const existingVariant = products.find(p => p.judul === judul && p.data.variant === variantName);
            
            if (existingVariant) { // Restock logic
                const newStok = (existingVariant.data.stok || 0) + stokToAdd;
                let newHistory = existingVariant.data.history || [];
                newHistory.push({ date: new Date().toISOString(), note: 'Barang Masuk (Quick Add)', change: stokToAdd });
                
                const updatedData = {
                    ...existingVariant.data,
                    stok: newStok,
                    history: newHistory,
                    lastModified: new Date().toISOString()
                };

                const { error } = await supabase
                    .from('variants')
                    .update({ data: updatedData })
                    .eq('id', existingVariant.uuid);
                
                if(error) {
                    console.error("Supabase error:", error);
                    showNotification('Gagal menambahkan stok: ' + error.message, 'error');
                } else {
                    await fetchAllData();
                    showNotification('Stok berhasil ditambahkan.');
                }
            } else { // New variant logic
                const master = productMasters[judul];
                const titleUuid = master.titleUuid;
                const gambarUrl = await uploadImageAndGetUrl(quickAddGambarInput.files[0]);

                const newVariant = {
                    judul_id: titleUuid,
                    data: {
                        variant: variantName, 
                        stok: stokToAdd,
                        batchTag: batch,
                        gambar: gambarUrl,
                        kode: generateKode(titleUuid, variantName),
                        lokasi, batasMinimum, hargaNormal, hargaDiskon,
                        history: [{ date: new Date().toISOString(), note: 'Stok Awal', change: stokToAdd }],
                        lastModified: new Date().toISOString()
                    }
                };
                
                const { data, error } = await supabase
                    .from('variants')
                    .insert(newVariant)
                    .select();
                
                if(error) {
                    console.error("Supabase error:", error);
                    showNotification('Gagal menyimpan varian baru: ' + error.message, 'error');
                } else {
                    await fetchAllData();
                    showNotification('Varian baru berhasil disimpan.');
                }
            }

            quickAddModal.style.display = 'none';
            quickAddVariantNameInput.value = '';
            quickAddStokInput.value = '';
            quickAddBatchInput.value = '';
            quickAddGambarInput.value = '';
            quickAddHargaNormalInput.value = '';
            quickAddHargaDiskonInput.value = '';
        });


        // MENU 3: DESKRIPSI
        descJudulPilihanInput.addEventListener('input', () => { 
            const judul = descJudulPilihanInput.value;
            if (!judul || !productMasters[judul]) {
                generatedDescriptionTextarea.value = '';
                return;
            }

            const master = productMasters[judul].data;
            const variants = products.filter(p => p.judul === judul);

            let desc = `${judul}\n\n`;
            desc += `Kondisi: ${master.kondisi}\n`;
            if (master.rilis) {
                const [year, month] = master.rilis.split('-');
                const rilisDate = new Date(year, month - 1);
                desc += `Rilis: ${rilisDate.toLocaleDateString('id-ID', { year: 'numeric', month: 'long' })} (Jepang)\n`;
            }
            desc += `Asal: ${master.asal}\n`;
            desc += `Brand: ${master.brand}\n\n`;

            desc += `Varian:\n`;
            variants.forEach((v, i) => {
                desc += `${i + 1}. ${v.data.variant}\n`;
            });
            desc += `\n`;

            desc += `Fitur Produk:\n`;
            (master.fitur || []).forEach(f => {
                desc += `- ${f}\n`;
            });
             if (master.keterangan) {
                desc += `\n${master.keterangan}\n`;
            }

            generatedDescriptionTextarea.value = desc;
        });

        copyDescriptionBtn.addEventListener('click', () => { 
            generatedDescriptionTextarea.select();
            document.execCommand('copy');
            showNotification('Deskripsi berhasil disalin!', 'info');
        });

        // Print & Export
        downloadImagesBtn.addEventListener('click', async () => {
            const selected = Array.from(productListContainer.querySelectorAll('.variant-checkbox:checked'));
            if (selected.length === 0) { showNotification('Pilih varian yang gambarnya ingin diunduh.', 'error'); return; }

            const links = [];
            const sanitize = (name) => name ? name.replace(/[\\?%*:|"<>]/g, '_') : 'file';
            
            const getExtension = (url) => {
                const urlObj = new URL(url);
                const path = urlObj.pathname;
                const extension = path.split('.').pop();
                return extension || 'jpg';
            };

            const selectedUuids = selected.map(cb => cb.closest('.variant-item').dataset.uuid);
            const selectedProducts = products.filter(p => selectedUuids.includes(p.uuid));
            const processedTitles = new Set();
            
            for (const product of selectedProducts) {
                // Add variant image
                if (product.data.gambar) {
                    const fileName = `${sanitize(product.data.batchTag || 'NO_BATCH')}_${sanitize(product.judul)}_${sanitize(product.data.variant)}.${getExtension(product.data.gambar)}`;
                    links.push({name: fileName, href: product.data.gambar});
                }

                // Add master image only once per group
                if (!processedTitles.has(product.judul)) {
                    const master = productMasters[product.judul]?.data;
                    if (master && master.gambar) {
                        const codePrefix = product.data.kode ? product.data.kode.split('-')[0] : 'master';
                        const masterFileName = `${sanitize(product.data.batchTag || 'NO_BATCH')}_${sanitize(product.judul)}_${codePrefix}-Nippori.${getExtension(master.gambar)}`;
                        links.push({name: masterFileName, href: master.gambar});
                    }
                    processedTitles.add(product.judul);
                }
            }

            if (links.length > 0) {
                downloadLinksList.innerHTML = links.map(link => `<li><a href="${link.href}" download="${link.name}" target="_blank">${link.name}</a></li>`).join('');
                downloadImagesModal.style.display = 'flex';
            } else {
                showNotification('Tidak ada gambar untuk diunduh pada produk yang dipilih.', 'info');
            }
        });

        printThermalBtn.addEventListener('click', () => {
             const selected = Array.from(productListContainer.querySelectorAll('.variant-checkbox:checked'));
             if (selected.length === 0) { showNotification('Pilih varian untuk dicetak.', 'error'); return; }
             
             let printContent = '';
             let itemsInRow = 0;
             
             selected.forEach(cb => {
                 const uuid = cb.closest('.variant-item').dataset.uuid;
                 const product = products.find(p => p.uuid === uuid);
                 if (product) {
                     for (let i = 0; i < product.data.stok; i++) {
                         if (itemsInRow % 2 === 0) printContent += '<div class="print-row">';
                         printContent += `<div class="print-box">${product.data.kode}</div>`;
                         itemsInRow++;
                         if (itemsInRow % 2 === 0) printContent += '</div>';
                     }
                 }
             });
             if (itemsInRow % 2 !== 0) printContent += '</div>';
             
             const previewWindow = window.open('', '_blank');
             previewWindow.document.write(`
                <html><head><title>Cetak Label</title>
                <style>
                    body { margin: 0; font-family: monospace;}
                    @page { size: 80mm auto; margin: 1mm; }
                    .print-row { display: flex; width: 78mm; page-break-inside: avoid; }
                    .print-box { 
                        width: 38mm; height: 8mm; box-sizing: border-box; 
                        border: 1px solid black; font-size: 8pt; 
                        display: flex; justify-content: center; align-items: center;
                        overflow: hidden; white-space: nowrap;
                    }
                </style>
                </head><body>${printContent}</body></html>
             `);
             previewWindow.document.close();
             setTimeout(() => {
                 previewWindow.print();
             }, 250);
        });

        printPdfBtn.addEventListener('click', () => {
            const selected = Array.from(productListContainer.querySelectorAll('.variant-checkbox:checked'));
            if (selected.length === 0) {
                showNotification('Pilih setidaknya satu produk untuk dicetak.', 'error');
                return;
            }
            pdfOptionsModal.style.display = 'flex';
        });

        generatePdfBtn.addEventListener('click', async () => {
            const options = {
                gambar: document.getElementById('pdf-opt-gambar').checked,
                kode: document.getElementById('pdf-opt-kode').checked,
                stok: document.getElementById('pdf-opt-stok').checked,
                hargaNormal: document.getElementById('pdf-opt-harga-normal').checked,
                hargaDiskon: document.getElementById('pdf-opt-harga-diskon').checked,
                persenDiskon: document.getElementById('pdf-opt-persen-diskon').checked,
                batch: document.getElementById('pdf-opt-batch').checked,
                lokasi: document.getElementById('pdf-opt-lokasi').checked,
            };

            const selectedUuids = Array.from(productListContainer.querySelectorAll('.variant-checkbox:checked'))
                .map(cb => cb.closest('.variant-item').dataset.uuid);
            const selectedProducts = products.filter(p => selectedUuids.includes(p.uuid));

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const margin = 10;
            const pageHeight = doc.internal.pageSize.height;
            const pageWidth = doc.internal.pageSize.width;
            let y = margin;
            const itemsPerRow = 3;
            const boxWidth = (pageWidth - (margin * (itemsPerRow + 1))) / itemsPerRow;

            const rows = [];
            for (let i = 0; i < selectedProducts.length; i += itemsPerRow) {
                rows.push(selectedProducts.slice(i, i + itemsPerRow));
            }

            for(const rowItems of rows){
                let maxRowHeight = 0;

                // 1st pass: Calculate max height for the current row
                for (const product of rowItems) {
                    let contentHeight = 5;
                    const titleLines = doc.setFontSize(9).splitTextToSize(product.judul, boxWidth - (options.gambar ? 27 : 10));
                    const variantLines = doc.setFontSize(8).splitTextToSize(product.data.variant, boxWidth - (options.gambar ? 27 : 10));
                    contentHeight += titleLines.length * 3.5;
                    contentHeight += variantLines.length * 3;
                    
                    let detailLines = 0;
                    if(options.kode) detailLines++;
                    if(options.stok) detailLines++;
                    if(options.batch) detailLines++;
                    if(options.lokasi) detailLines++;
                    if(options.hargaNormal || options.hargaDiskon || options.persenDiskon) detailLines++;
                    contentHeight += detailLines * 4;

                    const imageHeight = (options.gambar && product.data.gambar) ? 25 : 0;
                    const requiredHeight = Math.max(imageHeight, contentHeight) + 5;
                    maxRowHeight = Math.max(maxRowHeight, requiredHeight);
                }

                if (y + maxRowHeight > pageHeight - margin) {
                    doc.addPage();
                    y = margin;
                }

                let x = margin;
                // 2nd pass: Draw all items in the row with uniform height
                for (const product of rowItems) {
                    doc.setDrawColor(150);
                    doc.rect(x, y, boxWidth, maxRowHeight);

                    let textY = y + 5;
                    if (options.gambar && product.data.gambar) {
                        try {
                            const img = new Image();
                            img.crossOrigin = "Anonymous";
                            img.src = product.data.gambar;
                            await new Promise((resolve, reject) => { 
                                img.onload = resolve; 
                                img.onerror = () => {
                                    console.error("Could not load image for PDF:", product.data.gambar);
                                    resolve(); // Resolve anyway to not break PDF generation
                                }
                            });
                             if (img.complete && img.naturalHeight !== 0) {
                                doc.addImage(img, 'JPEG', x + 2, textY, 20, 20);
                            }
                        } catch (e) { console.error("PDF Image Error:", e); }
                    }

                    doc.setFontSize(9).setTextColor(0, 0, 0);
                    const titleLines = doc.splitTextToSize(product.judul, boxWidth - (options.gambar ? 25 : 8));
                    doc.text(titleLines, x + (options.gambar ? 25 : 5), textY + 3);
                    let currentY = textY + 3 + (titleLines.length * 3.5);

                    doc.setFontSize(8);
                    const variantLines = doc.splitTextToSize(product.data.variant, boxWidth - (options.gambar ? 25 : 8));
                    doc.text(variantLines, x + (options.gambar ? 25 : 5), currentY + 2);
                    
                    textY = y + 30;
                    
                    doc.setFontSize(7);
                    if (options.kode) { doc.text(`Kode: ${product.data.kode || '-'}`, x + 5, textY); textY += 4; }
                    if (options.stok) { doc.text(`Stok: ${product.data.stok || '0'}`, x + 5, textY); textY += 4; }
                    if (options.batch) { doc.text(`Batch: ${product.data.batchTag || '-'}`, x + 5, textY); textY += 4; }
                    if (options.lokasi) { doc.text(`Lokasi: ${product.data.lokasi || '-'}`, x + 5, textY); textY += 4; }
                    
                    let hargaText = "";
                    if(options.hargaNormal) hargaText += `N: ${new Intl.NumberFormat('id-ID').format(product.data.hargaNormal || 0)}`;
                    if(options.hargaDiskon) hargaText += ` D: ${new Intl.NumberFormat('id-ID').format(product.data.hargaDiskon || 0)}`;
                    if(options.persenDiskon && product.data.hargaDiskon > 0 && product.data.hargaDiskon < product.data.hargaNormal) {
                        const diskon = Math.round(((product.data.hargaNormal - product.data.hargaDiskon) / product.data.hargaNormal) * 100);
                        hargaText += ` (${diskon}%)`;
                    }
                    if (hargaText) { doc.text(hargaText.trim(), x + 5, textY, {maxWidth: boxWidth - 10});}
                    
                    x += boxWidth + margin;
                }
                y += maxRowHeight + margin;
            };

            doc.save('daftar-produk-pilihan.pdf');
            pdfOptionsModal.style.display = 'none';
        });

        // Sold Items Modal
        soldItemsCard.addEventListener('click', () => {
            renderSoldItemsList();
            soldItemsModal.style.display = 'flex';
        });
        
        // Master Report Modal
        masterProductsCard.addEventListener('click', () => {
            renderMasterReportList();
            masterReportModal.style.display = 'flex';
        });

        [masterReportSort, masterReportRilisStart, masterReportRilisEnd].forEach(el => el.addEventListener('input', renderMasterReportList));

        function renderMasterReportList() {
            let masters = Object.entries(productMasters).map(([judul, data]) => ({ judul, ...data }));

            const sortOrder = masterReportSort.value;
            masters.sort((a,b) => sortOrder === 'asc' ? a.data.createdAt - b.data.createdAt : b.data.createdAt - a.data.createdAt);

            const startDate = masterReportRilisStart.value;
            const endDate = masterReportRilisEnd.value;

            if (startDate) masters = masters.filter(m => m.data.rilis >= startDate);
            if (endDate) masters = masters.filter(m => m.data.rilis <= endDate);

            if (masters.length > 0) {
                masterReportModalList.innerHTML = masters.map((m, index) => `
                    <li>
                        <span>
                           <strong>${index + 1}. ${m.judul}</strong><br>
                            <small>Brand: ${m.data.brand} | Asal: ${m.data.asal}</small>
                        </span>
                        <span>
                            Rilis: ${m.data.rilis || '-'}
                        </span>
                    </li>
                `).join('');
            } else {
                masterReportModalList.innerHTML = '<li>Tidak ada data master yang cocok dengan filter.</li>';
            }
        }

        [soldStartDateInput, soldEndDateInput].forEach(el => el.addEventListener('input', () => renderSoldItemsList()));

        function renderSoldItemsList() {
            let allSoldItems = [];
            products.forEach(p => {
                if(p.data.history) {
                    p.data.history.forEach(h => {
                        if(h.itemsSold > 0) {
                            allSoldItems.push({ ...h, judul: p.judul, variant: p.data.variant });
                        }
                    });
                }
            });

            const allTimeSold = allSoldItems.reduce((sum, item) => sum + item.itemsSold, 0);
            const allTimeRevenue = allSoldItems.reduce((sum, item) => sum + item.revenue, 0);
            
            soldItemsTotalsEl.innerHTML = `<strong>Total Keseluruhan:</strong> ${allTimeSold} pcs terjual - ${new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(allTimeRevenue)}`;


            const startDate = soldStartDateInput.value ? new Date(soldStartDateInput.value).setHours(0,0,0,0) : null;
            const endDate = soldEndDateInput.value ? new Date(soldEndDateInput.value).setHours(23,59,59,999) : null;

            let filteredSoldItems = allSoldItems;
            if (startDate || endDate) {
                filteredSoldItems = allSoldItems.filter(item => {
                    const itemDate = new Date(item.date).getTime();
                    const startMatch = startDate ? itemDate >= startDate : true;
                    const endMatch = endDate ? itemDate <= endDate : true;
                    return startMatch && endMatch;
                });
            }

            filteredSoldItems.sort((a,b) => new Date(b.date) - new Date(a.date)); // Newest first

            if(filteredSoldItems.length > 0) {
                soldItemsModalList.innerHTML = filteredSoldItems.map((item, index) => `
                    <li>
                        <span>
                            <strong>${index + 1}. ${item.judul} - ${item.variant}</strong><br>
                            <small>${new Date(item.date).toLocaleString('id-ID')}</small>
                        </span>
                        <span>
                            ${item.itemsSold} pcs - <strong>${new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(item.revenue)}</strong>
                        </span>
                    </li>
                `).join('');
            } else {
                soldItemsModalList.innerHTML = '<li>Tidak ada data penjualan pada rentang waktu ini.</li>';
            }
        }

        // Close popups
        [imagePopupClose, quickAddModalClose, historyModalClose, editModalClose, soldItemsModalClose, masterReportModalClose, pdfOptionsModalClose, downloadImagesModalClose].forEach(btn => {
            btn.addEventListener('click', () => {
                btn.closest('.modal-overlay').style.display = 'none';
            })
        });

        lowStockBatchFilter.addEventListener('input', () => {
            lowStockCurrentPage = 1; 
            renderLowStockSection();
        });

        lowStockPaginationContainer.addEventListener('click', (e) => {
            if (e.target.matches('.page-btn')) {
                lowStockCurrentPage = parseInt(e.target.dataset.page);
                renderLowStockSection();
            }
        });

        lowStockListEl.addEventListener('click', (e) => {
            const target = e.target;
            
            if (target.matches('.image-preview-trigger')) {
                const imgSrc = target.dataset.imgSrc;
                if(imgSrc) {
                    popupImg.src = imgSrc;
                    imagePopup.style.display = 'flex';
                }
                return;
            }

            if (target.matches('.low-stock-link')) {
                const li = target.closest('li');
                const product = products.find(p => p.uuid === li.dataset.uuid);
                if (product) {
                    document.querySelector('.nav-links a[href="#data-list"]').click();
                    setTimeout(() => {
                        searchInput.value = product.data.kode; 
                        searchInput.dispatchEvent(new Event('input'));
                    }, 100);
                }
                return;
            }

            const uuid = target.closest('[data-uuid]')?.dataset.uuid;
            if (!uuid) return;

            if (target.classList.contains('edit-btn')) {
                const productToEdit = products.find(p => p.uuid === uuid);
                if (productToEdit) {
                    editUuidInput.value = productToEdit.uuid;
                    editVariantNameInput.value = productToEdit.data.variant;
                    editHargaNormalInput.value = productToEdit.data.hargaNormal || 0;
                    editHargaDiskonInput.value = productToEdit.data.hargaDiskon || 0;
                    editStokInput.value = productToEdit.data.stok;
                    editBatchInput.value = productToEdit.data.batchTag || '';
                    editGambarPreview.src = productToEdit.data.gambar || '';
                    editGambarVariantInput.value = '';
                    editLokasiInput.value = productToEdit.data.lokasi || '';
                    editBatasMinimumInput.value = productToEdit.data.batasMinimum || 0;
                    editStokNoteSelect.value = 'Koreksi Manual';
                    editStokNoteOtherContainer.style.display = 'none';
                    editStokNoteOtherInput.value = '';
                    editModal.style.display = 'flex';
                }
            }

            if (target.classList.contains('delete-btn')) {
                if (confirm('Yakin ingin menghapus varian ini?')) {
                    supabase.from('variants').delete().eq('id', uuid)
                        .then(() => {
                            products = products.filter(p => p.uuid !== uuid);
                            fetchAllData();
                            showNotification('Varian berhasil dihapus.');
                        }).catch(error => {
                            console.error("Supabase error:", error);
                            showNotification('Gagal menghapus varian.', 'error');
                        });
                }
            }
        });
        
        // --- Add manifest link ---
        const manifestScript = document.getElementById('manifest');
        if (manifestScript) {
            const manifest = manifestScript.textContent;
            const blob = new Blob([manifest], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(blob);
            document.querySelector('link[rel="manifest"]').setAttribute('href', manifestURL);
        }
    });
    </script>
</body>
</html>
